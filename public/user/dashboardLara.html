<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>Dashboard Analista</title>
    <!-- apex -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/apexcharts/3.37.1/apexcharts.min.js"></script>

    <!-- bootstrap -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet">

    <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">

    <!-- css -->
    <link rel="stylesheet" href="../css/dashLara.css">
    <script src="../components/customMain/custommain.js"></script>
    <script src="../components/navbar/navbar.js"></script>
</head>

<body onload="buscarServidoresComAlerta()">
    <nav-bar></nav-bar>
    <custom-main>

        <!-- KPI -->
        <div class="kpi-container">

            <div class="kpi">
                <h2>Componente com mais alertas</h2>
                <h1>CPU</h1>
            </div>

            <div class="kpi">
                <h2>Total de alertas em 24h</h2>
                <h1>4</h1>
            </div>

            <div class="kpi">
                <h2>Chamados não atendidos</h2>
                <h1>3</h1>
            </div>

        </div>


        <!-- lista de servidores -->
        <div class="listagem-titulo">
            <h1>Servidores com componentes em estado CRÍTICO</h1>
        </div>


        <div class="listagem-container">
            <div class="table-custom">
                <table class="table table-hover mb-0">
                    <thead>
                        <tr>
                            <th>Servidor</th>
                            <th>Status</th>
                            <th>CPU</th>
                            <th>Memória RAM</th>
                            <th>Disco</th>
                            <th>Mais detalhes</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td class="nomeServidor" id="servidor">Servidor 01</td>
                            <td><span class="status" id="status">Crítico</span></td>
                            <td><span class="metric-warning">80%</span></td>
                            <td><span class="metric-normal">70%</span></td>
                            <td><span class="metric-normal">65%</span></td>
                            <td>
                                <!-- olho -->
                                <button class="button-eye" data-target="chartServidores">
                                    <i class="bi bi-eye"></i>
                                </button>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>

        </div> <!--div listagem-container  -->

        <!-- gráfico servidores -->
        <div class="chart-wrapper" id="chartServidores" style="display: none;">
            <div id="graficoServidor"></div>
        </div>

        <!-- slack -->
        <div class="slack-container">
            <div class="slack">
                <h1>Slack</h1>
            </div>
        </div>

        <!-- gráfico do status -->
        <div class="chart-container">
            <h1>Status dos Servidores</h1><br>
            <div class="chart" id="chart"></div>
        </div>


    </custom-main>
</body>

<script>

    //mostrar e esconder os gráficos
    document.querySelectorAll('.button-eye').forEach(button => {
        button.addEventListener('click', () => {
            const chartId = button.getAttribute('data-target');
            const chartDiv = document.getElementById(chartId);
            chartDiv.style.display = chartDiv.style.display === 'none' ? 'block' : 'none';
        });
    });

    //gráfico de linha dos servidores
    const lineChartOptions = {

        series: [
            {
                name: "CPU",
                data: [30, 40, 35, 50, 49, 60, 70, 91, 125]
            },
            {
                name: "MemóriaRAM",
                data: [20, 30, 25, 40, 45, 55, 60, 85, 100]
            },
            {
                name: "Disco",
                data: [10, 25, 20, 30, 35, 45, 55, 70, 90]
            }
        ],
        chart: {
            height: 350,
            type: 'line',
            zoom: { enabled: false }
        },
        dataLabels: { enabled: false },
        stroke: { curve: 'straight' },
        title: {
            text: 'Uso de Recursos dos Servidores',
            align: 'left'
        },
        grid: {
            row: {
                colors: ['#f3f3f3', 'transparent'],
                opacity: 0.5
            },
        },
        xaxis: {
            categories: ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep']
        }
    };

    const lineChart = new ApexCharts(document.querySelector("#graficoServidor"), lineChartOptions);
    lineChart.render();


    //chart status dos servidores
    var options = {
        series: [55, 13],
        chart: {
            width: 380,
            type: 'pie',
        },
        labels: ['Normal', 'Crítico'],
        responsive: [{
            breakpoint: 480,
            options: {
                chart: {
                    width: 200
                },
                legend: {
                    position: 'bottom'
                }
            }
        }]
    };

    var chart = new ApexCharts(document.querySelector("#chart"), options);
    chart.render();


    async function buscarServidoresComAlerta() {
        try {
            const fk_company = sessionStorage.ID_EMPRESA || 1;
            const response = await fetch(`/servidores/listarServidoresComAlerta/${fk_company}`);

            if (!response.ok) {
                throw new Error(`Erro ao buscar servidores: ${response.status}`);
            }

            const alertas = await response.json();
            console.log(alertas);
        } catch (error) {
            console.error("Erro ao buscar alertas:", error);
            Alert.error("Erro", "Não foi possível carregar os alertas. Por favor, tente novamente mais tarde.");
        }
    }

</script>

</html>